name: Build Aseprite for Windows

on:
  workflow_dispatch:  # Runs only when manually triggered

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout the workflow repository
        uses: actions/checkout@v4

      - name: Set Release Type
        run: echo "RELEASE_TYPE=${{ github.event.inputs.release_type || 'stable' }}" >> $GITHUB_ENV
        shell: bash

      - name: Install Dependencies
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          choco install ninja
          choco install git
          choco install mingw

      - name: Clone Aseprite Source (Stable/Beta)
        run: |
          if [[ "$RELEASE_TYPE" == "stable" ]]; then
            git clone --recursive --branch main https://github.com/aseprite/aseprite.git aseprite
          else
            git clone --recursive --branch beta https://github.com/aseprite/aseprite.git aseprite
          fi
        shell: bash

      - name: Download and Extract Skia
        run: |
          mkdir -p skia
          cd skia
          LATEST_RELEASE=$(curl -sL https://github.com/aseprite/skia/releases/latest | grep -oP 'Skia-Windows-Release-x64.zip"(?=[^"]*")' | head -1 | sed 's/"//g')
          SKIA_URL="https://github.com/aseprite/skia/releases/latest/download/$LATEST_RELEASE"
          echo "Downloading Skia from: $SKIA_URL"
          curl -L "$SKIA_URL" -o Skia-Windows-Release-x64.zip
          unzip Skia-Windows-Release-x64.zip
          rm Skia-Windows-Release-x64.zip
          echo "SKIA_DIR=$(pwd)" >> $GITHUB_ENV
        shell: bash

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo \
                -DCMAKE_IGNORE_PATH='C:/ProgramData/chocolatey/bin/;C:/Strawberry/c/bin/' \
                -DLAF_BACKEND=skia \
                -DSKIA_DIR=../skia \
                -DSKIA_LIBRARY_DIR=../skia/out/Release-x64 \
                -G Ninja ..
        working-directory: aseprite
        shell: bash

      - name: Build Aseprite
        run: |
          ninja aseprite
        working-directory: aseprite/build
        shell: bash

      - name: Package Aseprite
        run: |
          cd aseprite/build/bin
          zip -r aseprite-${{ env.RELEASE_TYPE }}-windows.zip aseprite.exe
        shell: bash

      - name: Upload Release Artifact
        uses: actions/upload-artifact@v3
        with:
          name: aseprite-${{ env.RELEASE_TYPE }}-windows
          path: aseprite/build/bin/aseprite-${{ env.RELEASE_TYPE }}-windows.zip

      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        with:
          files: aseprite/build/bin/aseprite-${{ env.RELEASE_TYPE }}-windows.zip
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
